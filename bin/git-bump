#!/usr/bin/env bash
#
# This script takes the latest git tag (whose format follows the rules of
# semantic versioning), increments the patch number and then creates a new git
# tag using this incremented version.
#
# Suppose that you have the following tag on your repo:
#   v1.0.0
# Doing a `git bump`, the following tag will be created:
#   v1.0.1
#
# You can also pass a "matcher" (or a prefix) to search for different tags:
#   git bump v
#   git bump stable
#   git bump testing
#
set -e

dir=$(dirname "${BASH_SOURCE[0]}")
source "${dir}/../lib/git.sh"
source "${dir}/../lib/utils.sh"

if ! git::repo?; then
  echo "Not a git repository."
  exit 1
fi

echo "Fetching tags..."
git fetch --tags >/dev/null 2>&1

prefix=${1-v} # "v" is the default prefix
latest_tag=$(git::latest_tag "$prefix" || :)

if [ -z "$latest_tag" ]; then
  echo "No previous tag found."
  exit 1
fi

new_tag=$(semver::increment_patch "$latest_tag")

echo "The current tag is ${latest_tag}"
echo "The new tag will be ${new_tag}"

read -n1 -p "Press [y] to continue..." -r key
echo ""

if [ "${key}" != "y" ]; then
  echo "Aborted"
  exit 1
fi

git tag "${new_tag}" -m "${new_tag}"
